name: Release

on:
  push:
    tags: ['v*.*.*']

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Cache Conan
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: conan2-${{ runner.os }}-${{ hashFiles('**/conanfile.*', 'conan.lock') }}
          restore-keys: |
            conan2-${{ runner.os }}-

      - name: Install Conan
        uses: conan-io/setup-conan@v1
        with:
          version: "2.10.1"

      - name: Init Conan config & profile
        shell: bash
        run: |
          conan profile detect --force

      - name: Check for golang package in Conan
        shell: bash
        run: |
          echo "🔍 Checking for golang package in Conan..."
          if conan search golang --remote=all 2>/dev/null | grep -q "golang/"; then
            echo "✅ golang package found in Conan remote repositories"
          else
            echo "⚠️  golang package not found in Conan remote repositories"
            echo "📦 Creating golang package locally..."

            # Check if conanfile-golang.py exists
            if [ ! -f "conanfile-golang.py" ]; then
              echo "❌ conanfile-golang.py not found in project root"
              exit 1
            fi

            # Create golang package locally
            echo "🔨 Creating golang package from local recipe..."
            conan create conanfile-golang.py --build=missing

            echo "✅ golang package created locally and available for use"
          fi

      - name: Install dependencies with Conan
        run: |
          # Create Conan profile if it doesn't exist
          conan profile show default >/dev/null 2>&1 || conan profile detect --force

          # Install dependencies
          conan install . --build=missing

      - name: Configure CMake preset
        run: |
          cmake --preset conan-release

      - name: Download dependencies
        run: go mod download

      - name: Build for current platform
        run: |
          cmake --build --preset conan-release --target version

          # On Linux, the version target creates bin/version-linux-amd64-static
          # We need to copy it to bin/version for artifact upload
          if [[ -f "bin/version-linux-amd64-static" ]]; then
            cp bin/version-linux-amd64-static bin/version
          fi

      - name: Build for all platforms
        run: |
          cmake --build --preset conan-release --target version-all

      - name: Create GoReleaser binary backup
        run: |
          ./buildtools/create-goreleaser-backup.sh

      - name: Create archives in GoReleaser format
        run: |
          ./buildtools/create-goreleaser-archives.sh

      - name: Create install scripts
        run: |
          # Clean installers directory to remove old installers
          rm -rf installers/

          VERSION=$(bin/version version 2>/dev/null || echo "v0.0.0")

          # Create simple installers in installers/ directory
          ./buildtools/create-all-installers.sh "${VERSION}" "installers"

      - name: Run GoReleaser release
        run: |
          # Install GoReleaser
          go install github.com/goreleaser/goreleaser@latest
          
          # Set the token explicitly for GoReleaser
          export GITHUB_TOKEN="$GORELEASER_GITHUB_TOKEN"
          
          # Run release
          goreleaser release --clean
        env:
          # Use PAT for cross-repository access to scoop-bucket and homebrew-tap
          GORELEASER_GITHUB_TOKEN: ${{ secrets.GORELEASER_GITHUB_TOKEN }}