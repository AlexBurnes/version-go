name: Release

on:
  push:
    tags: ['v*.*.*']

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'

      - name: Install Conan
        uses: conan-io/conan-action@v2
        with:
          conan-version: 2.0

      - name: Check for golang package in Conan
        run: |
          echo "üîç Checking for golang package in Conan..."
          if conan search golang --remote=all 2>/dev/null | grep -q "golang/"; then
            echo "‚úÖ golang package found in Conan remote repositories"
          else
            echo "‚ö†Ô∏è  golang package not found in Conan remote repositories"
            echo "üì¶ Creating golang package locally..."
            
            # Check if conanfile-golang.py exists
            if [ ! -f "conanfile-golang.py" ]; then
              echo "‚ùå conanfile-golang.py not found in project root"
              exit 1
            fi
            
            # Create golang package locally
            echo "üî® Creating golang package from local recipe..."
            conan create conanfile-golang.py --build=missing
            
            echo "‚úÖ golang package created locally and available for use"
          fi

      - name: Install dependencies with Conan
        run: |
          # Create Conan profile if it doesn't exist
          conan profile show default >/dev/null 2>&1 || conan profile detect --force
          
          # Install dependencies
          conan install . --build=missing

      - name: Download dependencies
        run: go mod download

      - name: Release with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # –ï—Å–ª–∏ –≤–∞—à Scoop bucket –ø—Ä–∏–≤–∞—Ç–Ω—ã–π/–¥—Ä—É–≥–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
          # GORELEASER_GITHUB_TOKEN: ${{ secrets.PAT_SCOOP }}
