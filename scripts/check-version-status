#!/bin/bash

# Version status checking script
# Used by AI assistant to check version status before making changes

set -e

# Colors for output
if [[ -t 1 ]] && [[ -z "${NO_COLOR-}" ]] && [[ "${TERM-}" != "dumb" ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

echo -e "${BLUE}üîç Checking version status...${NC}"

# Get current version using built utility or git describe
CURRENT_TAG=""

# Try to use built version utility first
if [[ -f "scripts/version" ]]; then
    CURRENT_TAG=$(scripts/version version 2>/dev/null || echo "")
    if [[ -n "$CURRENT_TAG" ]]; then
        echo -e "Current version (from built utility): ${GREEN}$CURRENT_TAG${NC}"
    fi
fi

# Fallback to git describe if version utility not available or failed
if [[ -z "$CURRENT_TAG" ]]; then
    CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
    echo -e "Current git tag: ${GREEN}$CURRENT_TAG${NC}"
fi

# Get VERSION file content
if [[ -f "VERSION" ]]; then
    VERSION_FILE=$(cat VERSION)
    echo -e "VERSION file: ${GREEN}$VERSION_FILE${NC}"
else
    echo -e "VERSION file: ${RED}NOT FOUND${NC}"
    echo -e "${RED}‚ùå VERSION file is required for this project${NC}"
    echo -e "${YELLOW}üí° Create VERSION file with: echo 'v0.5.8' > VERSION${NC}"
    exit 1
fi

# Check if versions match
if [[ "$CURRENT_TAG" == "$VERSION_FILE" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  VERSION file ($VERSION_FILE) matches current tag ($CURRENT_TAG)${NC}"
    echo -e "${YELLOW}üìù Suggestion: Increment version before making changes:${NC}"
    echo -e "   ${BLUE}./scripts/version-bump patch${NC}    # for bug fixes"
    echo -e "   ${BLUE}./scripts/version-bump minor${NC}    # for new features" 
    echo -e "   ${BLUE}./scripts/version-bump major${NC}    # for breaking changes"
    echo ""
    echo -e "${YELLOW}Then make your changes and follow the workflow in DEVELOPER_WORKFLOW.md${NC}"
    exit 1
else
    echo -e "${GREEN}‚úÖ Version status OK${NC}"
    echo -e "VERSION file ($VERSION_FILE) differs from current tag ($CURRENT_TAG)"
    echo -e "${GREEN}Ready to make changes!${NC}"
    exit 0
fi